{% extends 'base.html' %}

{% block title %}{{ lesson.title }} - {{ course.title }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-9">
        <!-- Lesson Title -->
        <h2>{{ lesson.title }}</h2>
        <p class="text-muted">
            <a href="{% url 'courses:detail' course.id %}">{{ course.title }}</a> ‚Ä¢ Lesson {{ lesson.order }}
        </p>

        <!-- Video Player -->
        {% if lesson.video_file %}
        <div class="ratio ratio-16x9 mb-3">
            <video controls class="rounded" controlsList="nodownload">
                <source src="{{ lesson.video_file.url }}" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>
        {% else %}
        <div class="alert alert-warning">
            <h5>üìπ No Video Available</h5>
            <p class="mb-0">Video content for this lesson is not yet uploaded.</p>
        </div>
        {% endif %}

        <!-- Lesson Details Card -->
        <div class="card mb-3">
            <div class="card-body">
                <h5>üìñ About This Lesson</h5>
                <p>{{ lesson.description|default:"No description provided for this lesson." }}</p>

                <hr>

                <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div>
                        <span class="badge bg-primary">‚è±Ô∏è Duration: {{ lesson.duration }} minutes</span>

                        {% if lesson.pdf_file %}
                        <a href="{{ lesson.pdf_file.url }}" class="btn btn-outline-primary btn-sm ms-2" download>
                            üìÑ Download PDF Notes
                        </a>
                        {% endif %}
                    </div>

                    <!-- Student Progress Actions -->
                    <div>
                        {% if user.profile.role == 'student' %}
                        {% if progress and progress.completed %}
                        <span class="badge bg-success fs-6">‚úÖ Completed</span>
                        {% else %}
                        <a href="{% url 'courses:mark_complete' lesson.id %}" class="btn btn-success">
                            ‚úì Mark as Completed
                        </a>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation Buttons -->
        <div class="d-flex justify-content-between mb-3">
            <a href="{% url 'courses:detail' course.id %}" class="btn btn-outline-secondary">
                ‚Üê Back to Course
            </a>

            {% if user.profile.role == 'student' %}
            <a href="{% url 'live_sessions:request' lesson.id %}" class="btn btn-warning">
                üí¨ Start Doubt Session
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar - All Lessons -->
    <div class="col-md-3">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">üìö Course Lessons</h6>
            </div>
            <div class="list-group list-group-flush" style="max-height: 70vh; overflow-y: auto;">
                {% for l in all_lessons %}
                <a href="{% url 'courses:lesson_watch' l.id %}"
                    class="list-group-item list-group-item-action {% if l.id == lesson.id %}active{% endif %}">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <small class="fw-bold">{{ forloop.counter }}. {{ l.title|truncatewords:4 }}</small>
                        </div>
                        <small class="text-nowrap ms-2">{{ l.duration }}m</small>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}